# PRD: מסך הגדרת שאלת מחקר (Define)

## מידע כללי
| פרט | ערך |
|-----|-----|
| **שם המסך** | Define Research Question |
| **נתיב** | `/define` |
| **קובץ** | `frontend/app/define/page.tsx` |
| **עדיפות** | P0 - קריטי |
| **סטטוס** | מיושם (v1.0), נדרש עדכון ל-v2.0 |
| **גרסה** | 2.0 |

---

## 1. סקירה כללית

### 1.1 מטרת המסך
מסך Define הוא כלי AI-Assisted לניסוח שאלת מחקר מובנית. המסך מאפשר למשתמש לנהל שיחה עם עוזר AI שמסייע לזהות ולמלא את מרכיבי המסגרת המחקרית הנבחרת.

### 1.2 ערך ייחודי
- **אוטומציה חכמה**: AI מזהה ומחלץ נתונים מהשיחה ומעדכן את הטופס אוטומטית
- **תמיכה דו-לשונית**: עברית ואנגלית עם RTL מלא
- **דינמיות**: מסגרות מתעדכנות מהשרת - אין צורך בשינוי קוד להוספת מסגרת חדשה

### 1.3 קהל יעד
- חוקרים בשלב התכנון הראשוני של מחקר
- סטודנטים שלומדים ניסוח שאלות מחקר
- ספרנים שמסייעים לחוקרים

---

## 2. דרישות פונקציונליות

### 2.1 יכולות ליבה

#### FR-DEF-001: צ'אט AI אינטראקטיבי
| פרט | תיאור |
|-----|-------|
| **תיאור** | שיחה טבעית עם AI לגיבוש שאלת המחקר |
| **קלט** | טקסט חופשי בעברית או אנגלית |
| **פלט** | תגובה מעוצבת ב-Markdown עם חילוץ שדות |
| **API** | `POST /api/v1/define/chat` |

#### FR-DEF-002: טופס מסגרת דינמי
| פרט | תיאור |
|-----|-------|
| **תיאור** | טופס שמתעדכן לפי סוג המסגרת הנבחרת |
| **מקור** | Schema מהשרת (`GET /api/v1/define/frameworks`) |
| **עדכון** | אוטומטי מ-AI + ידני ע"י המשתמש |
| **שמירה** | `PATCH /api/v1/projects/{id}` |

#### FR-DEF-003: חילוץ נתונים אוטומטי
| פרט | תיאור |
|-----|-------|
| **תיאור** | AI מזהה מרכיבי מסגרת בשיחה וממלא את הטופס |
| **אינדיקציה** | Badge "Extracted" ליד שדות שמולאו |
| **Toast** | הודעה על עדכון הטופס |

#### FR-DEF-004: בחירת שפה
| פרט | תיאור |
|-----|-------|
| **תיאור** | בחירה ראשונית של שפת השיחה |
| **אפשרויות** | עברית (🇮🇱) / English (🇺🇸) |
| **השפעה** | כיווניות טקסט, הודעות ברירת מחדל, כפתורים |

#### FR-DEF-005: ייצוא פרוטוקול
| פרט | תיאור |
|-----|-------|
| **תיאור** | הורדת מסמך טקסט עם כל נתוני המסגרת והשיחה |
| **פורמט** | Markdown-like text file |
| **תוכן** | שם פרויקט, מסגרת, שדות, היסטוריית שיחה |

#### FR-DEF-006: ניקוי היסטוריה
| פרט | תיאור |
|-----|-------|
| **תיאור** | מחיקת כל הודעות הצ'אט והתחלה מחדש |
| **אישור** | דיאלוג confirm לפני מחיקה |
| **API** | `DELETE /api/v1/define/conversation/{project_id}` |

---

## 3. ממשק משתמש

### 3.1 מבנה Split-Screen

```
┌─────────────────────────────────────────────────────────────────────┐
│  Header Bar                                                          │
│  ✨ Define Research Question    [Project ▼]    [💾 Save] [⬇️] [🗑️] │
├─────────────────────────────┬───────────────────────────────────────┤
│  LEFT PANEL (50%)           │  RIGHT PANEL (50%)                    │
│  Framework Form              │  AI Chat                              │
│                              │                                       │
│  ┌────────────────────────┐ │  ┌─────────────────────────────────┐ │
│  │ [PICO] Framework    ▼  │ │  │ ✨ Welcome!                      │ │
│  └────────────────────────┘ │  │ Choose your language:            │ │
│                              │  │ [🇮🇱 עברית] [🇺🇸 English]        │ │
│  P - Population              │  └─────────────────────────────────┘ │
│  ┌────────────────────────┐ │                                       │
│  │                        │ │  ┌─────────────────────────────────┐ │
│  │                        │ │  │ 👤 User message...               │ │
│  └────────────────────────┘ │  └─────────────────────────────────┘ │
│                              │                                       │
│  I - Intervention [Extracted]│  ┌─────────────────────────────────┐ │
│  ┌────────────────────────┐ │  │ ✨ AI response in markdown...    │ │
│  │ Treatment with...      │ │  │ **Analysis:**                    │ │
│  │                        │ │  │ - Point 1                        │ │
│  └────────────────────────┘ │  │ - Point 2                        │ │
│                              │  └─────────────────────────────────┘ │
│  C - Comparison              │                                       │
│  ┌────────────────────────┐ │                                       │
│  │                        │ │                                       │
│  └────────────────────────┘ │  ┌─────────────────────────────────┐ │
│                              │  │ [Type your message...    ] [➤]  │ │
│  O - Outcome                 │  └─────────────────────────────────┘ │
│  ┌────────────────────────┐ │                                       │
│  │                        │ │                                       │
│  └────────────────────────┘ │                                       │
└─────────────────────────────┴───────────────────────────────────────┘
```

### 3.2 רכיבי ממשק

#### Header Bar
| רכיב | תפקיד |
|------|-------|
| Logo + Title | זיהוי המסך |
| Project Selector | בחירת פרויקט פעיל (Dropdown) |
| Save Button | שמירה ידנית של הפרויקט |
| Export Button | הורדת פרוטוקול |
| Clear Button | מחיקת היסטוריית צ'אט |

#### Left Panel - Framework Form
| רכיב | תפקיד |
|------|-------|
| Framework Selector | החלפת סוג מסגרת |
| Framework Badge | הצגת המסגרת הנוכחית |
| Dynamic Fields | Textareas לכל שדה במסגרת |
| Extracted Badge | אינדיקציה לשדה שמולא אוטומטית |

#### Right Panel - AI Chat
| רכיב | תפקיד |
|------|-------|
| Welcome Screen | בחירת שפה (מוצג רק בהתחלה) |
| Message List | הודעות משתמש ו-AI |
| User Avatar | עיגול עם "Me" / "אני" |
| AI Avatar | אייקון ✨ |
| Input Area | Textarea + כפתור שליחה |
| Loading Indicator | Spinner בזמן עיבוד |

### 3.3 עיצוב הודעות

#### הודעת משתמש
```
┌───────────────────────────────────┐
│ 👤                                │
│    ┌───────────────────────────┐  │
│    │ I want to study diabetes  │  │
│    │ treatment in elderly...   │  │
│    └───────────────────────────┘  │
└───────────────────────────────────┘
```

#### הודעת AI
```
┌───────────────────────────────────┐
│                              ✨   │
│  ┌───────────────────────────┐    │
│  │ ## Analysis               │    │
│  │ Based on your description:│    │
│  │                           │    │
│  │ **Population:** Elderly   │    │
│  │ **Intervention:** ...     │    │
│  └───────────────────────────┘    │
└───────────────────────────────────┘
```

---

## 4. זרימת משתמש

### 4.1 זרימה ראשית

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ בחירת פרויקט │ ──▶ │ בחירת שפה    │ ──▶ │ שיחה עם AI  │
└──────────────┘     └──────────────┘     └──────────────┘
                                                │
                                                ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ שמירה/ייצוא │ ◀── │ עריכה ידנית  │ ◀── │ מילוי אוטומטי│
└──────────────┘     └──────────────┘     └──────────────┘
```

### 4.2 תרחישים

#### תרחיש 1: משתמש חדש
1. משתמש בוחר פרויקט
2. מסך פתיחה מציג בחירת שפה
3. משתמש בוחר עברית
4. מוצגת הודעת פתיחה בעברית
5. משתמש מתאר את המחקר
6. AI מנתח ומחלץ מרכיבים
7. טופס מתמלא אוטומטית
8. משתמש מעדכן ידנית אם צריך
9. שמירה

#### תרחיש 2: המשך שיחה קיימת
1. משתמש בוחר פרויקט
2. היסטוריית צ'אט נטענת
3. טופס מציג נתונים שמורים
4. משתמש ממשיך את השיחה

---

## 5. ממשקי API

### 5.1 קריאות נדרשות

| פעולה | Method | Endpoint | תיאור |
|-------|--------|----------|-------|
| קבלת מסגרות | GET | `/api/v1/define/frameworks` | Schema לכל המסגרות |
| שליחת הודעה | POST | `/api/v1/define/chat` | שליחה וקבלת תגובה+חילוץ |
| היסטוריה | GET | `/api/v1/define/conversation/{id}` | טעינת שיחה קיימת |
| מחיקת היסטוריה | DELETE | `/api/v1/define/conversation/{id}` | איפוס שיחה |
| עדכון פרויקט | PATCH | `/api/v1/projects/{id}` | שמירת framework_data |

### 5.2 מבנה בקשת צ'אט

```typescript
interface ChatRequest {
  project_id: string;
  message: string;
  framework_type: string;
  language: "he" | "en";
}
```

### 5.3 מבנה תגובת צ'אט

```typescript
interface ChatResponse {
  message: string;  // Markdown formatted
  extracted_fields?: Record<string, string>;  // Optional auto-extraction
}
```

### 5.4 מבנה מסגרת

```typescript
interface FrameworkSchema {
  name: string;
  description: string;
  fields: {
    key: string;
    label: string;
    description: string;
  }[];
}
```

---

## 6. לוגיקה עסקית

### BR-DEF-001: זיהוי מסגרת אוטומטי
- AI יכול להמליץ על מסגרת מתאימה בהודעה
- המערכת מזהה patterns כמו "המסגרת המומלצת: SPIDER"
- אם מזוהה, המסגרת מוחלפת אוטומטית עם Toast

### BR-DEF-002: Merge של נתונים
- נתונים שחולצו מתמזגים עם קיימים (לא מחליפים הכל)
- משתמש יכול לערוך ידנית אחרי חילוץ
- שמירה שומרת את המצב הנוכחי בלבד

### BR-DEF-003: שפת ברירת מחדל
- אם לא נבחרה שפה, הצ'אט לא פעיל
- אחרי בחירת שפה, אי אפשר לשנות (צריך לנקות היסטוריה)

### BR-DEF-004: Markdown Rendering

- תגובות AI מעובדות כ-Markdown
- תמיכה ב: headers, bold, italic, lists, code
- RTL תקין בעברית

### BR-DEF-005: תרגום מונחים לאנגלית (חדש v2.0)

**חוק קריטי**: מאחר ש-PubMed לא תומך בחיפוש בעברית, כל המונחים המקצועיים חייבים להישמר באנגלית ב-`framework_data`.

#### כללי התרגום

| מצב | פעולה |
|-----|-------|
| משתמש כותב בעברית | AI מתרגם מונחים לאנגלית לפני שמירה |
| משתמש כותב באנגלית | נשמר כמו שהוא |
| מונח עם שם מסחרי | נשמר באנגלית עם השם הגנרי |

#### דוגמאות

| קלט משתמש (עברית) | שמירה ב-framework_data |
|-------------------|------------------------|
| "חולי סוכרת מבוגרים" | "elderly patients with type 2 diabetes" |
| "מטפורמין" | "metformin" |
| "תמותה מכל סיבה" | "all-cause mortality" |
| "ניסויים קליניים אקראיים" | "randomized controlled trials" |

#### System Prompt Addition

```text
CRITICAL: All medical/scientific terms extracted to framework_data
MUST be in English, regardless of conversation language.
PubMed only supports English searches.

When user writes in Hebrew:
1. Understand the Hebrew medical terms
2. Translate to proper English medical terminology
3. Save English terms to framework_data
4. Respond to user in their chosen language
```

### BR-DEF-006: חילוץ משופר מטקסט חופשי (חדש v2.0)

ה-AI צריך לזהות מרכיבי מסגרת גם מטקסט לא מובנה:

#### דוגמה לחילוץ

**קלט משתמש:**
```
אני רוצה לבדוק אם מטפורמין עוזר למבוגרים מעל גיל 65
עם סוכרת סוג 2 להפחית תמותה בהשוואה לאנשים שלא לוקחים את התרופה
```

**חילוץ מצופה (PICO):**
```json
{
  "P": "adults over 65 years with type 2 diabetes",
  "I": "metformin treatment",
  "C": "no metformin / placebo",
  "O": "all-cause mortality reduction"
}
```

### BR-DEF-007: ולידציית מונחים (חדש v2.0)

- AI מוודא שהמונחים שחולצו הם מונחים רפואיים תקינים
- מציע MeSH terms רלוונטיים כשאפשר
- מתריע על מונחים לא ברורים או כלליים מדי

---

## 7. משימות פיתוח

### 7.1 משימות קיימות (מיושמות)
- [x] Split-screen layout
- [x] Dynamic framework form
- [x] AI chat interface
- [x] Hebrew/English language selection
- [x] Auto-extraction of fields
- [x] Markdown rendering
- [x] RTL support
- [x] Export protocol
- [x] Clear history
- [x] Project selector
- [x] Toast notifications

### 7.2 משימות v2.0 (עדיפות גבוהה)

- [ ] **DEF-T010**: עדכון System Prompt לתרגום מונחים עברית→אנגלית
- [ ] **DEF-T011**: הוספת ולידציה שכל framework_data באנגלית
- [ ] **DEF-T012**: שיפור חילוץ מטקסט חופשי ולא מובנה
- [ ] **DEF-T013**: הוספת הצעות MeSH terms לשדות שחולצו
- [ ] **DEF-T014**: הוספת אינדיקציה "Translated" לשדות שתורגמו

### 7.3 משימות להשלמה

- [ ] **DEF-T001**: הוספת History לשיחה (Undo של הודעה אחרונה)
- [ ] **DEF-T002**: הוספת כפתור Copy לכל שדה
- [ ] **DEF-T003**: הוספת Suggested Prompts למשתמשים חדשים
- [ ] **DEF-T004**: הוספת Voice Input (Speech-to-Text)
- [ ] **DEF-T005**: הוספת מצב Dark/Light לצ'אט
- [ ] **DEF-T006**: הוספת Real-time collaboration (WebSocket)
- [ ] **DEF-T007**: הוספת Citation suggestions מ-AI
- [ ] **DEF-T008**: שיפור Mobile responsiveness
- [ ] **DEF-T009**: הוספת Keyboard shortcuts (Ctrl+Enter לשליחה)

---

## 8. מדדי הצלחה

| מדד | יעד | אופן מדידה |
|-----|-----|-----------|
| זמן תגובת AI | < 3 שניות | מרגע שליחה עד הצגת תגובה |
| דיוק חילוץ | > 80% | שדות נכונים מתוך שחולצו |
| שביעות רצון | > 4/5 | סקר משתמשים |
| זמן למילוי מסגרת | < 10 דקות | מהתחלה ועד שמירה |

---

## 9. טיפול בשגיאות

| שגיאה | טיפול | הודעה למשתמש |
|-------|-------|-------------|
| API timeout | Retry אחד, אז הודעת שגיאה | "Failed to send message" |
| No project selected | Disable input | "Please select a project" |
| Extraction failed | הצג תגובה בלי עדכון טופס | (אין הודעה, ממשיך רגיל) |
| Rate limit | Disable input זמנית | Toast עם countdown |

---

## 10. היסטוריית גרסאות

| גרסה | תאריך | שינויים |
|------|-------|---------|
| 1.0 | 2024-12 | גרסה ראשונית עם AI chat וטופס דינמי |
| 2.0 | 2024-12 | תרגום אוטומטי עברית→אנגלית, חילוץ משופר, ולידציית מונחים |

